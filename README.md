# AutoWire v2.0

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Python](https://img.shields.io/badge/python-3.7%2B-blue.svg)](https://www.python.org/)

AutoWire v2.0 æ˜¯ä¸€ä¸ªåŸºäº [PyVerilog](https://github.com/PyHDI/Pyverilog) çš„ Verilog SOC è‡ªåŠ¨è¿çº¿å·¥å…·ã€‚å®ƒèƒ½å¤Ÿè‡ªåŠ¨è§£æ Verilog æ¨¡å—ï¼Œæ ¹æ®é…ç½®æ–‡ä»¶è¿›è¡Œåè®®ä¿¡å·æ‰¹é‡åŒ¹é…å’Œç«¯å£è¿çº¿ï¼Œæœ€ç»ˆç”Ÿæˆé¡¶å±‚é›†æˆæ¨¡å—ã€‚

## ç‰¹æ€§

- ğŸ”§ **è‡ªåŠ¨è¿çº¿**: åŒååŒ¹é…åŸåˆ™ï¼Œæ”¯æŒåŸºäºåè®®ä¿¡å·çš„è‡ªåŠ¨è¿çº¿ï¼ˆAHBã€AXIã€APBã€è‡ªå®šä¹‰ä¿¡å·ç»„ç­‰ï¼‰
- ğŸ“ **çµæ´»é…ç½®**: ä½¿ç”¨ YAML é…ç½®æ–‡ä»¶è¿›è¡Œæ¨¡å—å®šä¹‰å’Œè¿çº¿é…ç½®
- ğŸ¯ **ç²¾ç¡®è§£æ**: åŸºäº PyVerilog è¿›è¡Œå‡†ç¡®çš„ Verilog è¯­æ³•è§£æ
- ğŸ”„ **å¢é‡ç”Ÿæˆ**: æ”¯æŒä¸­é—´é…ç½®æ–‡ä»¶ç”Ÿæˆï¼Œä¾¿äºè°ƒè¯•å’ŒéªŒè¯
- ğŸ“Š **è¯¦ç»†æ—¥å¿—**: æä¾›å®Œæ•´çš„è§£æå’Œè¿çº¿è¿‡ç¨‹æ—¥å¿—
- ğŸ› ï¸ **é«˜çº§ç‰¹æ€§**: æ”¯æŒæ¨¡å—å‚æ•°åŒ–å®ä¾‹ã€æ¡ä»¶ç¼–è¯‘ç­‰

## å®‰è£…è¦æ±‚

- Python 3.7+
- PyVerilog
- PyYAML

```bash
pip install pyverilog pyyaml
```

## å¿«é€Ÿå¼€å§‹

### 1. åŸºæœ¬ç”¨æ³•

```bash
python autowire.py -i vcn.yaml -b bounding.yaml -o output/
```

### 2. é…ç½®æ–‡ä»¶ç¤ºä¾‹

åˆ›å»ºä¸€ä¸ª YAML é…ç½®æ–‡ä»¶ï¼ˆä¾‹å¦‚ `test.yaml`ï¼‰ï¼š

```yaml
top_module: soc_top

# Global Define files (optional)  
define_files: 
  - ./autowire/rtl/define.vh
#  - ./rtl/global_define.vh

# Module definitions
rtl_path:
  - ./autowire/rtl/irqqqq.sv
  - ./autowire/rtl/cpu_core.v
  - ./autowire/rtl/uart_controller.v

# inst declare
instances:
  - module: cpu_core
    name: u_cpu
    parameters:

  - module: irqqqq
    name: u_irqqqq

  - module: uart_controller
    name: u_uart
    parameters:
      BAUD_RATE: 9600
      DATA_BITS: 16

##sub_moduel con
connections:
  u_cpu.a_hready : hready_out
  u_cpu.irq      : "{6'b0,irq[0],uart_irq}"
  u_uart.hsel_ahb: 1'b1
  u_cpu.test_in  : irq[1:0]
  u_uart.test_out:

##signal group con
bounding_con:
  - ahb:
      u_cpu.a_*    : cpu_ahbm_*
      u_uart.*_ahb  :  cpu_ahbm_*

```

### 3. è¾“å‡ºæ–‡ä»¶

AutoWire ä¼šç”Ÿæˆæ ‡å‡†çš„ Verilog é¡¶å±‚æ¨¡å—æ–‡ä»¶ï¼ŒåŒ…å«ï¼š

1. **æ¨¡å—å£°æ˜**: åŒ…å«æ‰€æœ‰å¤–éƒ¨ç«¯å£
2. **çº¿ç½‘å£°æ˜**: å†…éƒ¨è¿æ¥çº¿å£°æ˜
3. **å®ä¾‹åŒ–**: æ‰€æœ‰å­æ¨¡å—çš„å®ä¾‹åŒ–ä»£ç 
4. **æ³¨é‡Š**: è‡ªåŠ¨ç”Ÿæˆçš„æ—¶é—´æˆ³å’Œå·¥å…·ä¿¡æ¯

ç”Ÿæˆçš„ä»£ç ç¤ºä¾‹ï¼š

```verilog
// -----------------------------------------------------------------------------
// File      : soc_top.v
// Brief     : Auto-generated by autowire.py v2.0
// Author    : czz
// Date      : 2025-08-25 10:24:52
// -----------------------------------------------------------------------------

module soc_top(
    // u_cpu ports
    input          clk,
    input          rst_n,
    output  [2:0]  cpu_ahbm_hsize,
    output  [2:0]  cpu_ahbm_hburst,
    input          hready_out,
    input          debug_mode,

    // u_uart ports
    output         cpu_ahbm_hready_out,
    output         tx,
    input          rx
);

wire  [15:0]  cpu_ahbm_haddr ;
wire  [31:0]  cpu_ahbm_hrdata;
wire          cpu_ahbm_hresp ;
wire  [1:0]   cpu_ahbm_htrans;
wire  [31:0]  cpu_ahbm_hwdata;
wire          cpu_ahbm_hwrite;
wire  [7:0]   irq            ;
wire  [7:0]   uart_irq       ;

// Instance: u_cpu (cpu_core)
cpu_core u_cpu (
    .clk            (clk                   ),    // input 
    .rst_n          (rst_n                 ),    // input 
    .a_haddr        (cpu_ahbm_haddr        ),    // output [15:0]
    .a_hwdata       (cpu_ahbm_hwdata       ),    // output [31:0]
    .a_hrdata       (cpu_ahbm_hrdata       ),    // input  [31:0]
    .a_hwrite       (cpu_ahbm_hwrite       ),    // output
    .a_htrans       (cpu_ahbm_htrans       ),    // output [1:0]
    .a_hsize        (cpu_ahbm_hsize        ),    // output [2:0]
    .a_hburst       (cpu_ahbm_hburst       ),    // output [2:0]
    .a_hready       (hready_out            ),    // input 
    .a_hresp        (cpu_ahbm_hresp        ),    // input 
    .debug_mode     (debug_mode            ),    // input 
    .test_in        (irq[1:0]              ),    // input  [1:0]
    .irq            ({6'b0,irq[0],uart_irq})     // input  [7:0]
);

// Instance: u_irqqqq (irqqqq)
irqqqq u_irqqqq (
    .clk            (clk                   ),    // input 
    .rst_n          (rst_n                 ),    // input 
    .irq            (irq[1:0]              )     // output [1:0]
);

// Instance: u_uart (uart_controller)
uart_controller #(
    .BAUD_RATE(9600)
    .DATA_BITS(16)
) u_uart (
    .clk            (clk                   ),    // input 
    .rst_n          (rst_n                 ),    // input 
    .haddr_ahb      (cpu_ahbm_haddr        ),    // input  [15:0]
    .hwdata_ahb     (cpu_ahbm_hwdata       ),    // input  [31:0]
    .hrdata_ahb     (cpu_ahbm_hrdata       ),    // output [31:0]
    .hwrite_ahb     (cpu_ahbm_hwrite       ),    // input 
    .htrans_ahb     (cpu_ahbm_htrans       ),    // input  [1:0]
    .hsel_ahb       (1'b1                  ),    // input 
    .hready_out_ahb (cpu_ahbm_hready_out   ),    // output
    .hresp_ahb      (cpu_ahbm_hresp        ),    // output
    .tx             (tx                    ),    // output
    .rx             (rx                    ),    // input 
    .test_out       (                      ),    // output [15:0]
    .uart_irq       (uart_irq[0]           )     // output
);

endmodule
```


## å·¥ä½œåŸç†

AutoWire v2.0 é‡‡ç”¨æ¨¡å—åŒ–æ¶æ„ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹ç»„ä»¶ï¼š

### æ ¸å¿ƒæ¨¡å—

1. **Generator (`generator.py`)**: ä¸»æ§åˆ¶å™¨ï¼Œåè°ƒå„æ¨¡å—å·¥ä½œæµç¨‹
2. **Config Manager (`config_manager.py`)**: é…ç½®æ–‡ä»¶åŠ è½½å’Œç®¡ç†
3. **Parser (`parser.py`)**: åŸºäº PyVerilog çš„ Verilog ä»£ç è§£æ
4. **Connection Manager (`connection_manager.py`)**: è¿çº¿é€»è¾‘å¤„ç†
5. **Code Generator (`code_generator.py`)**: é¡¶å±‚æ¨¡å—ä»£ç ç”Ÿæˆ

### å·¥ä½œæµç¨‹

1. **é…ç½®åŠ è½½**: è§£æ YAML é…ç½®æ–‡ä»¶å’Œåè®®ä¿¡å·å®šä¹‰
2. **æ¨¡å—è§£æ**: ä½¿ç”¨ PyVerilog è§£æ RTL æ–‡ä»¶ï¼Œæå–ç«¯å£å’Œå‚æ•°ä¿¡æ¯
3. **è¿çº¿å¤„ç†**: 
   - å¤„ç†åè®®ä¿¡å·è¿çº¿ï¼ˆåŸºäºåˆ—è¡¨åŒ¹é…ï¼‰
   - å¤„ç†æ‰‹åŠ¨è¿çº¿é…ç½®
   - æ‰§è¡Œè‡ªåŠ¨è¿çº¿ï¼ˆåŒåä¿¡å·åŒ¹é…ï¼‰
4. **ä»£ç ç”Ÿæˆ**: ç”Ÿæˆé¡¶å±‚æ¨¡å— Verilog ä»£ç 

## å‘½ä»¤è¡Œé€‰é¡¹

```
usage: autowire.py [-h] [-i INPUT] [-o OUTPUT] [-b BOUNDING] [-d] [--version]

AutoWire v2.0 - Verilog SOC Integration Tool (Refactored)

optional arguments:
  -h, --help            show this help message and exit
  -i INPUT, --input INPUT
                        Input YAML configuration file (default: vcn.yaml)
  -o OUTPUT, --output OUTPUT
                        Output directory or .v/.sv file path (default: .)
  -b BOUNDING, --bounding BOUNDING
                        Protocol signals definition file (default: bounding.yaml)
  -d, --debug           Enable debug output
  --version             show program version number and exit
```

## ä½¿ç”¨ç¤ºä¾‹

```bash

# æŒ‡å®šé…ç½®æ–‡ä»¶å’Œè¾“å‡ºç›®å½•
python autowire.py -i soc_config.yaml -b bounding.yaml -o build/

# æŒ‡å®šé…ç½®æ–‡ä»¶ã€boundingä¿¡å·ã€è¾“å‡ºç›®å½•
python autowire.py -i soc_config.yaml -b bounding.yaml -o build/

# æŒ‡å®šè¾“å‡ºæ–‡ä»¶
python autowire.py -i soc_config.yaml -b bounding.yaml -o build/soc_top.v

# å¼€å¯è°ƒè¯•æ¨¡å¼
python autowire.py -i soc_config.yaml -b bounding.yaml -o build/soc_top.v -d
```


## é«˜çº§åŠŸèƒ½

### é€šé…ç¬¦è¿çº¿

æ”¯æŒä½¿ç”¨é€šé…ç¬¦è¿›è¡Œæ‰¹é‡è¿çº¿ï¼š

```yaml
bounding_con:
  - ahb:
      u_master.ahb_*: master_ahb_*      # åŒ¹é…æ‰€æœ‰ ahb_ å¼€å¤´çš„ç«¯å£
      u_slave.*_ahb: slave_ahb_*        # åŒ¹é…æ‰€æœ‰ _ahb ç»“å°¾çš„ç«¯å£
```

### å‚æ•°åŒ–å®ä¾‹

æ”¯æŒä¸ºå®ä¾‹æŒ‡å®šå‚æ•°ï¼š

```yaml
instances:
  - module: memory_controller
    name: u_memory
    parameters:
      ADDR_WIDTH: 32
      DATA_WIDTH: 64
      CACHE_LINES: 256
```

### ä¿¡å·æ‹¼æ¥

æ”¯æŒå¤æ‚çš„ä¿¡å·è¿æ¥è¡¨è¾¾å¼ï¼š

```yaml
connections:
  u_cpu.interrupt: "{irq_timer, irq_uart, 6'b0}"
  u_mux.select: "2'b01"
  u_module.data_out:                    # æ‚¬ç©ºè¿æ¥
```

## å¸¸è§é—®é¢˜

1. **æ‰¾ä¸åˆ°æ¨¡å—å®šä¹‰**
   - æ£€æŸ¥ `rtl_path` ä¸­çš„æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤æ¨¡å—åä¸æ–‡ä»¶ä¸­å®šä¹‰çš„æ¨¡å—åä¸€è‡´

2. **åè®®ä¿¡å·ä¸åŒ¹é…**
   - æ£€æŸ¥ `bounding.yaml` ä¸­çš„åè®®ä¿¡å·å®šä¹‰
   - éªŒè¯ç«¯å£åç§°æ˜¯å¦åŒ…å«åè®®ä¿¡å·å

3. **è§£æé”™è¯¯**
   - ä½¿ç”¨ `-d` é€‰é¡¹å¼€å¯è°ƒè¯•æ¨¡å¼æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
   - æ£€æŸ¥ Verilog è¯­æ³•æ˜¯å¦æ­£ç¡®

### è°ƒè¯•æ¨¡å¼

ä½¿ç”¨ `-d` é€‰é¡¹å¯ä»¥æŸ¥çœ‹è¯¦ç»†çš„æ‰§è¡Œè¿‡ç¨‹ï¼š

```bash
autowire.py -i ./vcn.yaml -b bounding.yaml -o ./out -d
```

è°ƒè¯•æ¨¡å¼ä¸‹ä¼šæ˜¾ç¤ºï¼š
- æ–‡ä»¶è§£æè¿‡ç¨‹
- ç«¯å£åŒ¹é…è¯¦æƒ…
- è¿çº¿ç”Ÿæˆä¿¡æ¯
- ä¸­é—´é…ç½®æ–‡ä»¶è·¯å¾„

#### DEBUGä¿¡æ¯ç¤ºä¾‹
```
python autowire.py -i ./vcn.yaml -b bounding.yaml -o ./out -d

2025-08-25 15:38:25 - INFO    - src.generator          - Starting SOC generation with new architecture...
2025-08-25 15:38:25 - INFO    - src.generator          - Loading configurations...
2025-08-25 15:38:25 - INFO    - src.config_manager     - Loaded configuration from ./vcn.yaml
2025-08-25 15:38:25 - INFO    - src.config_manager     - Loaded protocol signals from D:\work\autowire\bounding.yaml
2025-08-25 15:38:25 - INFO    - src.generator          - Parsing phase...
2025-08-25 15:38:25 - INFO    - src.parser             - Registered 1 define files
2025-08-25 15:38:25 - INFO    - src.generator          - Parsed 0 global defines
2025-08-25 15:38:25 - INFO    - src.generator          - Found 3 modules in RTL files
Generating LALR tables
WARNING: 183 shift/reduce conflicts
2025-08-25 15:38:26 - INFO    - src.parser             - Successfully parsed module cpu_core with 14 ports
Generating LALR tables
WARNING: 183 shift/reduce conflicts
2025-08-25 15:38:28 - INFO    - src.parser             - Successfully parsed module irqqqq with 3 ports
Generating LALR tables
WARNING: 183 shift/reduce conflicts
2025-08-25 15:38:29 - INFO    - src.parser             - Successfully parsed module uart_controller with 14 ports
2025-08-25 15:38:29 - INFO    - src.generator          - Connection phase...
2025-08-25 15:38:29 - INFO    - src.connection_manager - Processing protocol connections...
2025-08-25 15:38:29 - INFO    - src.connection_manager - Generated 17 protocol connections
2025-08-25 15:38:29 - INFO    - src.config_manager     - Created intermediate YAML file: D:\work\autowire\out\vcn_intermediate.yaml
2025-08-25 15:38:30 - INFO    - src.config_manager     - Loaded configuration from D:\work\autowire\out\vcn_intermediate.yaml
2025-08-25 15:38:30 - INFO    - src.connection_manager - Processing 20 manual connections
2025-08-25 15:38:30 - WARNING - src.connection_manager - Input width mismatch for irq: 8 vs 2
2025-08-25 15:38:30 - INFO    - src.connection_manager - Starting auto-connection of unconnected ports
2025-08-25 15:38:30 - INFO    - src.connection_manager - Auto-connection completed: 31/31 ports connected
2025-08-25 15:38:30 - INFO    - src.connection_manager - Total wires in wire_set: 17
2025-08-25 15:38:30 - INFO    - src.generator          - Code generation phase...
2025-08-25 15:38:30 - INFO    - src.code_generator     - Generating top-level ports in instance and port definition order
2025-08-25 15:38:30 - INFO    - src.code_generator     - Generated 9 top-level ports
2025-08-25 15:38:30 - INFO    - src.code_generator     - Generating top module to ./out\soc_top.v
2025-08-25 15:38:30 - WARNING - src.code_generator     - Width mismatch for wire irq: input=8, output=2, using max=8
2025-08-25 15:38:30 - WARNING - src.code_generator     - Width mismatch for wire uart_irq: input=8, output=1, using max=8
2025-08-25 15:38:30 - INFO    - src.code_generator     - Successfully generated ./out\soc_top.v
2025-08-25 15:38:30 - INFO    - src.generator          - Debug mode: keeping intermediate file D:\work\autowire\out\vcn_intermediate.yaml
2025-08-25 15:38:30 - INFO    - src.generator          - Generation completed successfully!
2025-08-25 15:38:30 - INFO    - __main__               - AutoWire v2.0 completed successfully!
```

## é¡¹ç›®ç»“æ„

```
autowire-master/
â”œâ”€â”€ autowire.py              # ä¸»å…¥å£è„šæœ¬
â”œâ”€â”€ bounding.yaml           # åè®®ä¿¡å·å®šä¹‰
â”œâ”€â”€ test.yaml              # ç¤ºä¾‹é…ç½®æ–‡ä»¶
â”œâ”€â”€ vcn.yaml               # å¦ä¸€ä¸ªé…ç½®æ–‡ä»¶ç¤ºä¾‹
â”œâ”€â”€ LICENSE                # MIT è®¸å¯è¯
â”œâ”€â”€ src/                   # æ ¸å¿ƒæºä»£ç 
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ generator.py       # ä¸»ç”Ÿæˆå™¨
â”‚   â”œâ”€â”€ config_manager.py  # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ parser.py          # Verilogè§£æå™¨
â”‚   â”œâ”€â”€ connection_manager.py  # è¿çº¿ç®¡ç†
â”‚   â”œâ”€â”€ code_generator.py  # ä»£ç ç”Ÿæˆ
â”‚   â”œâ”€â”€ data_structures.py # æ•°æ®ç»“æ„å®šä¹‰
â”‚   â””â”€â”€ logger.py          # æ—¥å¿—ç®¡ç†
â”œâ”€â”€ rtl/                   # RTL æ–‡ä»¶ç›®å½•
â””â”€â”€ test_output_v2/        # è¾“å‡ºç¤ºä¾‹
```

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## è®¸å¯è¯

æœ¬é¡¹ç›®åŸºäº MIT è®¸å¯è¯å¼€æºã€‚è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

## æ›´æ–°æ—¥å¿—

### v2.0.0 (é‡æ„ç‰ˆæœ¬)
- å®Œå…¨é‡æ„ä»£ç æ¶æ„ï¼Œæé«˜å¯ç»´æŠ¤æ€§
- ä¼˜åŒ–åè®®ä¿¡å·åŒ¹é…ç®—æ³•
- å¢å¼ºé”™è¯¯å¤„ç†å’Œæ—¥å¿—è¾“å‡º
- æ”¯æŒæ›´çµæ´»çš„é…ç½®é€‰é¡¹
- æ”¹è¿›ä»£ç ç”Ÿæˆè´¨é‡

---

## å¾…åŠ
- å°†[dma_controller](https://github.com/czz-zzc/dma_controller)ä½œä¸ºexampleå±•ç¤º
- æ”¯æŒparameterå»¶ç”³è‡³top
- æ”¯æŒæ•°æ®ç±»portè‡ªåŠ¨è¿çº¿

**æŠ€æœ¯æ”¯æŒ**: å¦‚æœ‰é—®é¢˜è¯·æäº¤ GitHub Issue








